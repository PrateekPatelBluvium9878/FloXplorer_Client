chrome.runtime.onMessage.addListener((o,s,e)=>{if(o.type==="GET_SID_COOKIE")return console.log("📩 [background.js] Request for SID cookie received for URL:",o.url),o.url?(chrome.cookies.get({url:o.url,name:"sid"},r=>{if(chrome.runtime.lastError){console.error("❌ [background.js] Error getting cookie:",chrome.runtime.lastError.message),e({error:chrome.runtime.lastError.message});return}r&&r.value?(console.log("✅ [background.js] SID cookie found."),e({sid:r.value})):(console.error("❌ [background.js] SID cookie not found for URL:",o.url),e({error:"SID cookie not found"}))}),!0):(console.error("❌ [background.js] URL not provided in request."),e({error:"URL not provided for SID cookie."}),!1);if(o.type==="FETCH_USER_INFO")return(async()=>{try{const r=`${o.baseUrl}/services/oauth2/userinfo`,t=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${o.sid}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Salesforce API error: ${t.status} ${await t.text()}`);const n=await t.json();e({success:!0,data:n})}catch(r){console.error("💥 [background.js] Error fetching user info:",r),e({success:!1,error:r.message})}})(),!0;if(o.type==="FETCH_FLOW_METADATA")return(async()=>{try{const r="58.0",t=`SELECT Id, Metadata FROM Flow WHERE Id='${o.flowId}'`,n=`${o.instanceUrl}/services/data/v${r}/tooling/query/?q=${encodeURIComponent(t)}`,a=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${o.sessionId}`,"Content-Type":"application/json"}});if(!a.ok)throw new Error(`Salesforce Tooling API error: ${a.status} ${await a.text()}`);const c=(await a.json()).records?.[0]?.Metadata||null;e({success:!0,data:c})}catch(r){console.error("💥 [background.js] Error fetching flow metadata:",r),e({success:!1,error:r.message})}})(),!0});
